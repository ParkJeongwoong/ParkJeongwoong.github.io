# JPA 영속성 컨텍스트

JPA를 사용한 코드를 보면 Entity를 수정/삭제할 때 DB에 쿼리를 보내는 부분(JpaRepository를 사용하는 코드)이 없는 것을 볼 수 있습니다.

이는 JPA의 `영속성 컨텍스트`라는 특징 때문이며 JPA의 핵심 개념이기도 합니다.

---

## 개념

**Entity를 영구 저장하는 환경** 을 뜻합니다.

EntityManager가 Entity를 관리할 때, Entity를 이 영속성 컨텍스트라는 환경에 넣고 관리하며 **Entity에 변경이 일어나면 트랜잭션이 끝나는 시점에 DB에 변경분을 반영**합니다.

즉 EntityManager를 통해서 DB의 Table 정보와 Entity 정보를 일치시키는 작업 환경을 말합니다.



## 동작과정

1. Transaction 발생

2. EntityManager 생성 (요청(Thread) 당 하나씩)
   
   - EntityManager는 DB Connection Pool을 사용해 DB와 연결

3. Entity를 역속성 컨텍스트에 등록 (영속)
   
   - 1차 캐시 : 캐시를 사용해서 조회, 수정,삭제
   
   - 쓰기 지연 : 변경 발생 시 바로 DB에 업데이트를 하지 않고 Transaction Commit이 되면 한 번에 DB에 쿼리 요청
   
   - 동일성 보장 : 1차 캐시에 저장된 엔티티의 동일성 보장 (여러 번 엔티티를 읽어도 캐싱 되어있는 동일한 엔티티를 반환)
   
   - **변경감지(Dirty Checking)** : 변경 사항을 자동으로 확인 후 DB에 반영 (이것 때문에 Entity 수정/삭제 쿼리가 없어도 됨)



## 생명주기

1. 비영속

엔티티 객체 생성

영속성 컨텍스트에 저장 X



2. 영속

엔티티 객체 생성

영속성 컨텍스트에 저장 O



3. 준영속

엔티티 객체 생성

영속성 컨텍스트에 저장

영속성 컨텍스트에서 제거 (더이상 관리 X)



4. 삭제

엔티티 객체 생성

영속성 컨텍스트에 저장

엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제